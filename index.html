<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>ChartFox Viewer</title>
</head>
<body>
  <h1>Connexion ChartFox + Recherche ICAO</h1>
  <button id="login">Se connecter à ChartFox</button>

  <div id="form" style="display:none;">
    <input id="icao" placeholder="Code OACI (ex: LFPG)" />
    <button id="search">Rechercher</button>
    <div id="result"></div>
  </div>

  <script>
    const client_id = "9f946a22-0dc6-4027-a66e-9678e653c478";
    const redirect_uri = "https://ninors.github.io/chartfox/";
    const scope = "charts:view charts:index charts:files charts:view_source_url";

    // Génère un code verifier PKCE
    function generateCodeVerifier() {
      const array = new Uint8Array(64);
      window.crypto.getRandomValues(array);
      return btoa(String.fromCharCode(...array))
        .replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
    }

    // Génère un code challenge SHA256 base64url
    async function generateCodeChallenge(codeVerifier) {
      const encoder = new TextEncoder();
      const data = encoder.encode(codeVerifier);
      const digest = await window.crypto.subtle.digest('SHA-256', data);
      return btoa(String.fromCharCode(...new Uint8Array(digest)))
        .replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
    }

    // Récupère param GET
    function getURLParam(name) {
      return new URLSearchParams(window.location.search).get(name);
    }

    document.getElementById('login').onclick = async () => {
      const codeVerifier = generateCodeVerifier();
      const codeChallenge = await generateCodeChallenge(codeVerifier);
      localStorage.setItem('code_verifier', codeVerifier);

      const authUrl = `https://api.chartfox.org/oauth/authorize?response_type=code&client_id=${client_id}&redirect_uri=${encodeURIComponent(redirect_uri)}&scope=${encodeURIComponent(scope)}&code_challenge=${codeChallenge}&code_challenge_method=S256`;
      window.location = authUrl;
    };

    async function handleOAuthRedirect() {
      const code = getURLParam('code');
      if (!code) return;

      const codeVerifier = localStorage.getItem('code_verifier');

      const response = await fetch('https://api.chartfox.org/oauth/token', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          grant_type: 'authorization_code',
          code,
          redirect_uri,
          client_id,
          code_verifier: codeVerifier
        })
      });

      const data = await response.json();
      if (data.access_token) {
        localStorage.setItem('access_token', data.access_token);
        history.replaceState({}, null, redirect_uri);
        document.getElementById("form").style.display = "block";
      } else {
        alert("Échec OAuth");
      }
    }

    // Récupérer les infos complètes d'une carte pour obtenir ses fichiers
    async function getChartDetails(chartId) {
      const token = localStorage.getItem("access_token");
      if (!token) {
        alert("Vous devez être connecté.");
        return null;
      }
      try {
        const resp = await fetch(`https://api.chartfox.org/v2/charts/${chartId}`, {
          headers: { Authorization: `Bearer ${token}` }
        });
        if (!resp.ok) throw new Error("Erreur API: " + resp.status);
        return await resp.json();
      } catch(e) {
        console.error(e);
        alert("Erreur lors de la récupération des détails de la carte.");
        return null;
      }
    }

    // Ouvre un lien direct vers le fichier PDF/PNG ou fallback vers view_url
    async function openChart(chartId) {
      const details = await getChartDetails(chartId);
      if (!details) return;

      // Priorité: fichiers internes first-party (files[].url), sinon view_url, sinon source_url
      if (details.files && details.files.length > 0) {
        window.open(details.files[0].url, "_blank");
      } else if (details.view_url) {
        window.open(details.view_url, "_blank");
      } else if (details.source_url) {
        window.open(details.source_url, "_blank");
      } else {
        alert("Aucun lien de fichier disponible pour cette carte.");
      }
    }

    document.getElementById("search").onclick = () => {
      const icao = document.getElementById("icao").value.trim().toUpperCase();
      const token = localStorage.getItem("access_token");
      if (!token) {
        alert("Vous devez être connecté.");
        return;
      }
      if (!icao) {
        alert("Veuillez saisir un code OACI valide.");
        return;
      }

      fetch(`https://api.chartfox.org/v2/airports/${icao}/charts/grouped`, {
        headers: { Authorization: `Bearer ${token}` }
      })
      .then(r => r.json())
      .then(data => {
        const out = document.getElementById("result");
        out.innerHTML = '';

        if (!data.data || Object.keys(data.data).length === 0) {
          out.innerHTML = '<p>Aucune carte trouvée.</p>';
          return;
        }

        Object.entries(data.data).forEach(([typeId, charts]) => {
          if (charts.length > 0) {
            const section = document.createElement("div");
            section.innerHTML = `<h2>${charts[0].type_key}</h2><ul>` +
              charts.map(c => `<li><a href="#" onclick="openChart('${c.id}'); return false;">${c.name}</a></li>`).join('') +
              `</ul>`;
            out.appendChild(section);
          }
        });
      })
      .catch(e => {
        console.error(e);
        document.getElementById("result").innerHTML = "Erreur lors de la récupération des cartes.";
      });
    };

    // Lancer la gestion OAuth au chargement
    handleOAuthRedirect();
  </script>
</body>
</html>
