<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>ChartFox Viewer intégré</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0; padding: 0;
      display: flex; height: 100vh; overflow: hidden;
    }
    #left-panel {
      width: 40%;
      padding: 10px;
      box-sizing: border-box;
      overflow-y: auto;
      border-right: 1px solid #ccc;
    }
    #right-panel {
      flex-grow: 1;
      position: relative;
    }
    #chart-frame {
      width: 100%; height: 100%;
      border: none;
    }
    input, button {
      font-size: 1rem;
      padding: 5px;
      margin-bottom: 10px;
      width: 100%;
      box-sizing: border-box;
    }
    .tabs {
      display: flex;
      border-bottom: 1px solid #ccc;
      margin-bottom: 10px;
    }
    .tab {
      padding: 5px 10px;
      cursor: pointer;
      border: 1px solid #ccc;
      border-bottom: none;
      background: #eee;
      margin-right: 5px;
      user-select: none;
    }
    .tab.active {
      background: white;
      font-weight: bold;
    }
    .charts-list {
      max-height: 70vh;
      overflow-y: auto;
    }
    .charts-list ul {
      list-style: none;
      padding-left: 0;
    }
    .charts-list li {
      margin: 3px 0;
    }
    .charts-list a {
      text-decoration: none;
      color: #007bff;
      cursor: pointer;
    }
    .charts-list a:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <div id="left-panel">
    <input id="icao" placeholder="Code OACI (ex: LFPG)" />
    <button id="search">Rechercher</button>

    <div id="tabs" class="tabs"></div>
    <div id="charts-container" class="charts-list"></div>
  </div>
  <div id="right-panel">
    <iframe id="chart-frame" src=""></iframe>
  </div>

<script>
  const client_id = "9f946a22-0dc6-4027-a66e-9678e653c478";
  const redirect_uri = "https://ninors.github.io/chartfox/"; // adapte à ton hébergement
  const scope = "charts:view charts:index charts:files";

  // --- OAuth Gestion simplifiée ---
  async function generateCodeVerifier() {
    const array = new Uint8Array(64);
    window.crypto.getRandomValues(array);
    return btoa(String.fromCharCode(...array))
      .replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
  }
  async function generateCodeChallenge(codeVerifier) {
    const encoder = new TextEncoder();
    const data = encoder.encode(codeVerifier);
    const digest = await window.crypto.subtle.digest('SHA-256', data);
    return btoa(String.fromCharCode(...new Uint8Array(digest)))
      .replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
  }
  function getURLParam(name) {
    return new URLSearchParams(window.location.search).get(name);
  }

  async function login() {
    const codeVerifier = await generateCodeVerifier();
    const codeChallenge = await generateCodeChallenge(codeVerifier);
    localStorage.setItem('code_verifier', codeVerifier);
    const authUrl = `https://api.chartfox.org/oauth/authorize?response_type=code&client_id=${client_id}&redirect_uri=${encodeURIComponent(redirect_uri)}&scope=${encodeURIComponent(scope)}&code_challenge=${codeChallenge}&code_challenge_method=S256`;
    window.location = authUrl;
  }

  async function handleOAuthRedirect() {
    const code = getURLParam('code');
    if (!code) return false;

    const codeVerifier = localStorage.getItem('code_verifier');
    if (!codeVerifier) return false;

    const resp = await fetch('https://api.chartfox.org/oauth/token', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        grant_type: 'authorization_code',
        code,
        redirect_uri,
        client_id,
        code_verifier: codeVerifier
      })
    });
    const data = await resp.json();
    if (data.access_token) {
      localStorage.setItem('access_token', data.access_token);
      history.replaceState({}, null, redirect_uri);
      return true;
    } else {
      alert("Échec de connexion OAuth");
      return false;
    }
  }

  async function getChartsGroupedByType(icao) {
    const token = localStorage.getItem('access_token');
    if (!token) return null;
    const resp = await fetch(`https://api.chartfox.org/v2/airports/${icao}/charts/grouped`, {
      headers: { Authorization: `Bearer ${token}` }
    });
    if (!resp.ok) throw new Error(`Erreur API: ${resp.status}`);
    const data = await resp.json();
    return data.data || {};
  }

  async function getChartDetails(chartId) {
    const token = localStorage.getItem('access_token');
    if (!token) throw new Error("Token manquant");
    const resp = await fetch(`https://api.chartfox.org/v2/charts/${chartId}`, {
      headers: { Authorization: `Bearer ${token}` }
    });
    if (!resp.ok) throw new Error(`Erreur API Chart Details: ${resp.status}`);
    return await resp.json();
  }

  // Gestion onglets
  let currentTab = null;
  function createTabs(types) {
    const tabs = document.getElementById('tabs');
    tabs.innerHTML = '';
    Object.entries(types).forEach(([typeKey, charts]) => {
      const tab = document.createElement('div');
      tab.className = 'tab';
      tab.textContent = charts[0].type_key || typeKey;
      tab.dataset.typeKey = typeKey;
      tab.onclick = () => {
        setActiveTab(typeKey);
      };
      tabs.appendChild(tab);
    });
  }

  function setActiveTab(typeKey) {
    if (currentTab === typeKey) return;
    currentTab = typeKey;

    // Set active class
    const tabs = document.querySelectorAll('.tab');
    tabs.forEach(t => t.classList.toggle('active', t.dataset.typeKey === typeKey));

    // Afficher les charts correspondants
    const chartsContainer = document.getElementById('charts-container');
    chartsContainer.innerHTML = '';
    const charts = window.allCharts[typeKey] || [];
    if (charts.length === 0) {
      chartsContainer.textContent = 'Aucune carte pour cet onglet.';
      return;
    }
    const ul = document.createElement('ul');
    charts.forEach(chart => {
      const li = document.createElement('li');
      const a = document.createElement('a');
      a.textContent = chart.name;
      a.href = "#";
      a.onclick = async (e) => {
        e.preventDefault();
        try {
          const details = await getChartDetails(chart.id);
          let url = details.view_url || details.url || details.source_url;
          if (!url) {
            alert("Pas de lien d'affichage disponible pour cette carte.");
            return;
          }
          // Afficher dans iframe
          document.getElementById('chart-frame').src = url;
        } catch (err) {
          alert("Erreur lors du chargement de la carte: " + err.message);
        }
      };
      li.appendChild(a);
      ul.appendChild(li);
    });
    chartsContainer.appendChild(ul);
  }

  document.getElementById('search').onclick = async () => {
    const icao = document.getElementById('icao').value.trim().toUpperCase();
    if (!icao) return alert("Merci de saisir un code OACI.");
    try {
      const groupedCharts = await getChartsGroupedByType(icao);
      window.allCharts = groupedCharts; // stock global
      createTabs(groupedCharts);
      // Activer premier onglet
      const firstTypeKey = Object.keys(groupedCharts)[0];
      if (firstTypeKey) setActiveTab(firstTypeKey);
      // Clear iframe au départ
      document.getElementById('chart-frame').src = "";
    } catch (err) {
      alert("Erreur lors de la récupération des cartes : " + err.message);
    }
  };

  // Au chargement, gérer OAuth redirect
  window.onload = async () => {
    const token = localStorage.getItem('access_token');
    if (!token) {
      const success = await handleOAuthRedirect();
      if (!success) {
        login();
      }
    }
  };
</script>
</body>
</html>
