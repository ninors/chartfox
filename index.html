<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>ChartFox Viewer</title>
<style>
    body { font-family: Arial, sans-serif; background: #1e1e1e; color: white; text-align: center; padding: 20px; }
    input, button { padding: 8px; font-size: 16px; margin: 5px; }
    button { cursor: pointer; }
    .chart-container { display: flex; flex-wrap: wrap; justify-content: center; }
    .chart { border: 1px solid #444; margin: 10px; padding: 10px; background: #2c2c2c; border-radius: 8px; width: 300px; }
    a { color: #4db8ff; }
</style>
</head>
<body>

<h1>ChartFox Viewer</h1>
<button id="loginBtn">Se connecter à ChartFox</button>

<div id="searchArea" style="display:none;">
    <h2>Rechercher un aéroport</h2>
    <input type="text" id="icao" placeholder="Ex: LFPG" maxlength="4">
    <button id="searchBtn">Rechercher</button>
</div>

<div id="charts"></div>

<script>
const clientId = "9f946a22-0dc6-4027-a66e-9678e653c478";
const redirectUri = "https://ninors.github.io/chartfox/";

async function generateCodeVerifier() {
    const array = new Uint8Array(32);
    crypto.getRandomValues(array);
    return btoa(String.fromCharCode(...array))
        .replace(/\+/g, "-").replace(/\//g, "_").replace(/=+$/, "");
}

async function generateCodeChallenge(verifier) {
    const data = new TextEncoder().encode(verifier);
    const digest = await crypto.subtle.digest("SHA-256", data);
    return btoa(String.fromCharCode(...new Uint8Array(digest)))
        .replace(/\+/g, "-").replace(/\//g, "_").replace(/=+$/, "");
}

document.getElementById("loginBtn").onclick = async () => {
    const verifier = await generateCodeVerifier();
    const challenge = await generateCodeChallenge(verifier);
    localStorage.setItem("code_verifier", verifier);

    const authUrl = `https://chartfox.org/oauth/authorize?response_type=code&client_id=${clientId}&redirect_uri=${encodeURIComponent(redirectUri)}&scope=read&code_challenge=${challenge}&code_challenge_method=S256`;

    window.location.href = authUrl;
};

async function exchangeCodeForToken(code) {
    const verifier = localStorage.getItem("code_verifier");
    const body = new URLSearchParams({
        grant_type: "authorization_code",
        code: code,
        redirect_uri: redirectUri,
        client_id: clientId,
        code_verifier: verifier
    });

    const response = await fetch("https://chartfox.org/oauth/token", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: body
    });
    return await response.json();
}

async function fetchCharts(icao, token) {
    const response = await fetch(`https://api.chartfox.org/airports/${icao}/charts`, {
        headers: { Authorization: `Bearer ${token}` }
    });
    return await response.json();
}

async function displayCharts(icao, token) {
    const chartsData = await fetchCharts(icao, token);
    const container = document.getElementById("charts");
    container.innerHTML = "";

    if (!chartsData || !chartsData.charts) {
        container.innerHTML = "<p>Aucune carte trouvée.</p>";
        return;
    }

    const grouped = {};
    chartsData.charts.forEach(chart => {
        if (!grouped[chart.category]) grouped[chart.category] = [];
        grouped[chart.category].push(chart);
    });

    for (const category in grouped) {
        const section = document.createElement("div");
        section.innerHTML = `<h3>${category}</h3>`;
        grouped[category].forEach(c => {
            const div = document.createElement("div");
            div.className = "chart";
            div.innerHTML = `<strong>${c.name}</strong><br><a href="${c.url}" target="_blank">Ouvrir</a>`;
            section.appendChild(div);
        });
        container.appendChild(section);
    }
}

window.onload = async () => {
    const params = new URLSearchParams(window.location.search);
    if (params.has("code")) {
        const code = params.get("code");
        const tokenData = await exchangeCodeForToken(code);
        localStorage.setItem("access_token", tokenData.access_token);
        window.history.replaceState({}, document.title, redirectUri);
        document.getElementById("searchArea").style.display = "block";
    } else if (localStorage.getItem("access_token")) {
        document.getElementById("searchArea").style.display = "block";
    }

    document.getElementById("searchBtn").onclick = () => {
        const icao = document.getElementById("icao").value.toUpperCase();
        displayCharts(icao, localStorage.getItem("access_token"));
    };
};
</script>

</body>
</html>
