<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>ChartFox Viewer intégré (Airport Interface)</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0; padding: 0;
      display: flex; height: 100vh; overflow: hidden;
    }
    #left-panel {
      width: 30%;
      padding: 10px;
      box-sizing: border-box;
      overflow-y: auto;
      border-right: 1px solid #ccc;
      background: #f9f9f9;
    }
    #right-panel {
      flex-grow: 1;
      position: relative;
    }
    #chart-frame {
      width: 100%; height: 100%;
      border: none;
    }
    input, button {
      font-size: 1rem;
      padding: 8px;
      margin-bottom: 10px;
      width: 100%;
      box-sizing: border-box;
    }
    #status {
      margin-top: 10px;
      font-size: 0.9rem;
      color: #555;
      min-height: 1.2em;
    }
  </style>
</head>
<body>

  <div id="left-panel">
    <h2>ChartFox Viewer</h2>
    <input id="icao" placeholder="Code OACI (ex: LFPG)" />
    <button id="search">Afficher les cartes</button>
    <div id="status"></div>
  </div>

  <div id="right-panel">
    <iframe id="chart-frame" src="" sandbox="allow-scripts allow-same-origin allow-forms"></iframe>
  </div>

<script>
  const client_id = "9f946a22-0dc6-4027-a66e-9678e653c478";
  const redirect_uri = "https://ninors.github.io/chartfox/"; // adapte à ton hébergement
  const scope = "charts:view charts:index charts:files";

  // Utilitaires OAuth PKCE
  async function generateCodeVerifier() {
    const array = new Uint8Array(64);
    window.crypto.getRandomValues(array);
    return btoa(String.fromCharCode(...array))
      .replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
  }
  async function generateCodeChallenge(codeVerifier) {
    const encoder = new TextEncoder();
    const data = encoder.encode(codeVerifier);
    const digest = await window.crypto.subtle.digest('SHA-256', data);
    return btoa(String.fromCharCode(...new Uint8Array(digest)))
      .replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
  }
  function getURLParam(name) {
    return new URLSearchParams(window.location.search).get(name);
  }

  // Lancer le flux OAuth
  async function login() {
    const codeVerifier = await generateCodeVerifier();
    const codeChallenge = await generateCodeChallenge(codeVerifier);
    localStorage.setItem('code_verifier', codeVerifier);
    const authUrl = `https://api.chartfox.org/oauth/authorize?response_type=code&client_id=${client_id}&redirect_uri=${encodeURIComponent(redirect_uri)}&scope=${encodeURIComponent(scope)}&code_challenge=${codeChallenge}&code_challenge_method=S256`;
    window.location = authUrl;
  }

  // Gérer le retour OAuth avec code pour récupérer le token
  async function handleOAuthRedirect() {
    const code = getURLParam('code');
    if (!code) return false;

    const codeVerifier = localStorage.getItem('code_verifier');
    if (!codeVerifier) return false;

    const resp = await fetch('https://api.chartfox.org/oauth/token', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        grant_type: 'authorization_code',
        code,
        redirect_uri,
        client_id,
        code_verifier: codeVerifier
      })
    });
    const data = await resp.json();
    if (data.access_token) {
      localStorage.setItem('access_token', data.access_token);
      history.replaceState({}, null, redirect_uri); // Nettoyer URL (supprimer ?code=)
      return true;
    } else {
      alert("Échec de connexion OAuth");
      return false;
    }
  }

  // Appeler l'interface airport intégrée, qui fournit une URL iframe valide
  async function getAirportInterfaceURL(icao) {
    const token = localStorage.getItem('access_token');
    if (!token) throw new Error("Token manquant, veuillez vous reconnecter.");

    const resp = await fetch(`https://api.chartfox.org/v2/interfaces/airport/${icao}`, {
      headers: { Authorization: `Bearer ${token}` }
    });
    if (!resp.ok) {
      if (resp.status === 401) {
        // Token expiré ou invalide, forcer nouvelle connexion
        localStorage.removeItem('access_token');
        login();
        throw new Error("Token expiré, reconnexion requise.");
      }
      throw new Error(`Erreur API: ${resp.status}`);
    }
    const data = await resp.json();
    if (!data.interface_url || !data.allowed_iframe) {
      throw new Error("Pas d'URL iframe disponible pour cet aéroport.");
    }
    return data.interface_url;
  }

  // Gestion UI et iframe
  const statusEl = document.getElementById('status');
  const iframe = document.getElementById('chart-frame');
  const icaoInput = document.getElementById('icao');
  const searchBtn = document.getElementById('search');

  searchBtn.onclick = async () => {
    const icao = icaoInput.value.trim().toUpperCase();
    if (!icao) return alert("Merci de saisir un code OACI.");

    statusEl.textContent = "Chargement...";
    iframe.src = "";

    try {
      const url = await getAirportInterfaceURL(icao);
      iframe.src = url;
      statusEl.textContent = `Affichage des cartes pour ${icao}`;
    } catch (err) {
      statusEl.textContent = "";
      alert("Erreur : " + err.message);
    }
  };

  // Au chargement, gérer OAuth et lancer login si besoin
  window.onload = async () => {
    let token = localStorage.getItem('access_token');
    if (!token) {
      const success = await handleOAuthRedirect();
      if (!success) {
        login();
      }
    } else {
      statusEl.textContent = "Prêt. Saisissez un code OACI.";
    }
  };
</script>

</body>
</html>
