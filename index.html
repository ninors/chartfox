<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>ChartFox avec Proxy</title>
  <style>
    body { font-family: Arial; margin: 0; padding: 20px; }
    #chart-list a { display: block; margin: 5px 0; cursor: pointer; color: blue; text-decoration: underline; }
    #viewer { margin-top: 20px; height: 600px; border: 1px solid #ccc; }
    iframe { width: 100%; height: 100%; border: none; }
  </style>
</head>
<body>

  <h2>Recherche cartes ChartFox</h2>
  <input id="icao" placeholder="Code OACI (ex: LFPG)" style="text-transform: uppercase" />
  <button id="search-btn">Rechercher</button>

  <div id="chart-list"></div>

  <div id="viewer">Aucune carte sélectionnée</div>

  <script>
    // URL proxy (bien finir par ?url=)
    const proxyBase = "https://chartfox-proxy.rouxsoumy-nino.workers.dev/?url=";

    // Token ChartFox à placer ici (remplace par ton vrai token OAuth)
    const token = "ton_token_oauth_ici"; // <- Remplace ici !

    const searchBtn = document.getElementById("search-btn");
    const icaoInput = document.getElementById("icao");
    const chartListDiv = document.getElementById("chart-list");
    const viewerDiv = document.getElementById("viewer");

    async function fetchCharts(icao) {
      const url = `https://api.chartfox.org/v2/airports/${icao}/charts`;
      const response = await fetch(url, {
        headers: { Authorization: `Bearer ${token}` }
      });
      if (!response.ok) throw new Error(`Erreur API: ${response.status}`);
      return await response.json();
    }

    function displayCharts(charts) {
      chartListDiv.innerHTML = "";
      if (!charts.length) {
        chartListDiv.textContent = "Aucune carte trouvée.";
        viewerDiv.textContent = "Aucune carte sélectionnée";
        return;
      }
      charts.forEach(chart => {
        const a = document.createElement("a");
        a.textContent = chart.name;
        a.href = "#";
        a.onclick = (e) => {
          e.preventDefault();
          showChart(chart);
        };
        chartListDiv.appendChild(a);
      });
    }

    function showChart(chart) {
      if (!chart.view_url) {
        viewerDiv.textContent = "Carte sans URL d’affichage.";
        return;
      }
      // Construire l'URL proxy avec encodage
      const url = proxyBase + encodeURIComponent(chart.view_url);
      viewerDiv.innerHTML = `<iframe src="${url}" title="${chart.name}"></iframe>`;
    }

    searchBtn.onclick = async () => {
      const icao = icaoInput.value.trim().toUpperCase();
      if (icao.length !== 4) {
        alert("Merci de saisir un code OACI valide à 4 lettres.");
        return;
      }
      try {
        chartListDiv.textContent = "Chargement...";
        viewerDiv.textContent = "";
        const data = await fetchCharts(icao);
        displayCharts(data.data || []);
      } catch (err) {
        chartListDiv.textContent = "Erreur lors de la récupération des cartes.";
        viewerDiv.textContent = "";
        console.error(err);
      }
    };
  </script>
</body>
</html>
