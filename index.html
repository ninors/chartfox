<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>ChartFox - Cache Local</title>
<style>
    body { background:#111; color:#fff; font-family:sans-serif; }
    #chartList { display:flex; flex-wrap:wrap; gap:10px; }
    .chart-btn { background:#222; padding:10px; border:none; color:white; cursor:pointer; }
    .chart-btn:hover { background:#444; }
    #chartViewer { margin-top:20px; width:100%; height:80vh; background:#000; }
    button { margin:5px; padding:5px 10px; }
</style>
</head>
<body>

<h2>ðŸ“‘ ChartFox Viewer avec Cache Local</h2>
<div>
    <input id="icaoInput" placeholder="Code OACI (ex: LFPG)">
    <button onclick="searchCharts()">Rechercher</button>
    <button onclick="clearCache()">ðŸ—‘ Vider le cache</button>
</div>

<div id="chartList"></div>
<div id="chartViewer"></div>

<script>
const CLIENT_ID = "TON_CLIENT_ID";
const REDIRECT_URI = window.location.origin + window.location.pathname;
const AUTH_URL = "https://chartfox.org/oauth/authorize";
const TOKEN_URL = "https://chartfox.org/oauth/token";
const API_BASE = "https://api.chartfox.org/v2";

async function startOAuth() {
    const codeVerifier = [...crypto.getRandomValues(new Uint8Array(32))]
        .map(b => b.toString(16).padStart(2, '0')).join('');
    const encoder = new TextEncoder();
    const hashBuffer = await crypto.subtle.digest("SHA-256", encoder.encode(codeVerifier));
    const codeChallenge = btoa(String.fromCharCode(...new Uint8Array(hashBuffer)))
        .replace(/\+/g, "-").replace(/\//g, "_").replace(/=+$/, "");
    localStorage.setItem("code_verifier", codeVerifier);
    window.location.href = `${AUTH_URL}?response_type=code&client_id=${CLIENT_ID}&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&code_challenge=${codeChallenge}&code_challenge_method=S256`;
}

async function handleOAuthCallback() {
    const params = new URLSearchParams(window.location.search);
    if (params.has("code")) {
        const code = params.get("code");
        const codeVerifier = localStorage.getItem("code_verifier");
        const body = new URLSearchParams({
            grant_type: "authorization_code",
            code,
            redirect_uri: REDIRECT_URI,
            client_id: CLIENT_ID,
            code_verifier: codeVerifier
        });
        const resp = await fetch(TOKEN_URL, { method:"POST", body });
        const data = await resp.json();
        localStorage.setItem("access_token", data.access_token);
        history.replaceState({}, document.title, REDIRECT_URI);
    }
}

async function searchCharts() {
    const token = localStorage.getItem("access_token");
    if (!token) return startOAuth();
    const icao = document.getElementById("icaoInput").value.trim().toUpperCase();
    const resp = await fetch(`${API_BASE}/airports/${icao}/charts`, {
        headers: { Authorization: `Bearer ${token}` }
    });
    const charts = await resp.json();
    document.getElementById("chartList").innerHTML = charts.map(c => 
        `<button class="chart-btn" onclick='showChart(${JSON.stringify(c)})'>${c.name}</button>`
    ).join("");
}

async function showChart(chart) {
    const viewer = document.getElementById("chartViewer");
    const cacheKey = `chart-${chart.id}`;
    let cachedData = localStorage.getItem(cacheKey);

    if (cachedData) {
        console.log("ChargÃ© depuis cache:", chart.id);
        viewer.innerHTML = embedHTML(cachedData, chart.fileExtension);
        return;
    }

    const token = localStorage.getItem("access_token");
    const resp = await fetch(`${API_BASE}/charts/${chart.id}/file`, {
        headers: { Authorization: `Bearer ${token}` }
    });
    const blob = await resp.blob();
    const url = URL.createObjectURL(blob);
    localStorage.setItem(cacheKey, url);
    viewer.innerHTML = embedHTML(url, chart.fileExtension);
}

function embedHTML(url, ext) {
    if (ext && ext.toLowerCase() === "pdf") {
        return `<embed src="${url}" type="application/pdf" width="100%" height="100%">`;
    }
    return `<img src="${url}" style="max-width:100%; height:auto;">`;
}

function clearCache() {
    Object.keys(localStorage).forEach(k => {
        if (k.startsWith("chart-")) localStorage.removeItem(k);
    });
    alert("Cache vidÃ© !");
}

handleOAuthCallback();
</script>
</body>
</html>
