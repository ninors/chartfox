<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>ChartFox Viewer avec Cache</title>
<style>
body {
    background-color: #111;
    color: #eee;
    font-family: Arial, sans-serif;
    padding: 20px;
}
#chartList button {
    background: #222;
    color: #fff;
    border: 1px solid #555;
    padding: 6px 12px;
    margin: 3px;
    cursor: pointer;
}
#chartViewer {
    margin-top: 20px;
    height: 80vh;
}
#chartViewer embed {
    width: 100%;
    height: 100%;
    border: none;
}
</style>
</head>
<body>

<h1>ðŸ“‘ ChartFox Viewer (avec Cache)</h1>

<input type="text" id="icaoInput" placeholder="Entrez code OACI">
<button onclick="fetchCharts()">Rechercher</button>
<button onclick="clearCache()">ðŸ—‘ Vider le cache</button>

<div id="chartList"></div>
<div id="chartViewer"></div>

<script>
const clientId = "TON_CLIENT_ID";
const redirectUri = window.location.origin + window.location.pathname; // mÃªme page
const authEndpoint = "https://chartfox.org/oauth/authorize";
const tokenEndpoint = "https://api.chartfox.org/oauth/token";

async function startOAuth() {
    const codeVerifier = [...crypto.getRandomValues(new Uint8Array(32))]
        .map(b => b.toString(16).padStart(2, "0")).join("");
    const encoder = new TextEncoder();
    const data = encoder.encode(codeVerifier);
    const digest = await crypto.subtle.digest("SHA-256", data);
    const codeChallenge = btoa(String.fromCharCode(...new Uint8Array(digest)))
        .replace(/=/g, "").replace(/\+/g, "-").replace(/\//g, "_");

    localStorage.setItem("code_verifier", codeVerifier);

    window.location = `${authEndpoint}?response_type=code&client_id=${clientId}&redirect_uri=${encodeURIComponent(redirectUri)}&code_challenge=${codeChallenge}&code_challenge_method=S256&scope=read`;
}

async function handleOAuthCallback() {
    const params = new URLSearchParams(window.location.search);
    if (params.has("code")) {
        const code = params.get("code");
        const verifier = localStorage.getItem("code_verifier");

        const resp = await fetch(tokenEndpoint, {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: new URLSearchParams({
                grant_type: "authorization_code",
                code: code,
                redirect_uri: redirectUri,
                client_id: clientId,
                code_verifier: verifier
            })
        });

        const data = await resp.json();
        if (data.access_token) {
            localStorage.setItem("access_token", data.access_token);
            history.replaceState({}, document.title, redirectUri); // nettoyer l'URL
        } else {
            alert("Erreur OAuth");
        }
    }
}

async function fetchCharts() {
    const token = localStorage.getItem("access_token");
    if (!token) {
        startOAuth();
        return;
    }

    const icao = document.getElementById("icaoInput").value.trim().toUpperCase();
    if (!icao) return;

    const resp = await fetch(`https://api.chartfox.org/v2/airports/${icao}/charts`, {
        headers: { Authorization: `Bearer ${token}` }
    });

    if (!resp.ok) {
        alert("Erreur API charts");
        return;
    }

    const charts = await resp.json();
    const listDiv = document.getElementById("chartList");
    listDiv.innerHTML = "";

    charts.forEach(chart => {
        const btn = document.createElement("button");
        btn.textContent = chart.name;
        btn.onclick = () => showChartInViewer(chart);
        listDiv.appendChild(btn);
    });
}

async function showChartInViewer(chart) {
    const viewerDiv = document.getElementById("chartViewer");
    const cacheKey = `chart-${chart.id}`;

    let cachedData = localStorage.getItem(cacheKey);

    if (cachedData) {
        console.log("Depuis cache:", chart.id);
        viewerDiv.innerHTML = `<embed src="${cachedData}" type="application/pdf">`;
        return;
    }

    const token = localStorage.getItem("access_token");
    const resp = await fetch(`https://api.chartfox.org/v2/charts/${chart.id}/file`, {
        headers: { Authorization: `Bearer ${token}` }
    });

    if (!resp.ok) {
        console.error("Erreur tÃ©lÃ©chargement", await resp.text());
        return;
    }

    const blob = await resp.blob();
    const url = URL.createObjectURL(blob);

    localStorage.setItem(cacheKey, url);

    viewerDiv.innerHTML = `<embed src="${url}" type="application/pdf">`;
}

function clearCache() {
    Object.keys(localStorage).forEach(k => {
        if (k.startsWith("chart-")) localStorage.removeItem(k);
    });
    alert("Cache vidÃ© !");
}

handleOAuthCallback();
</script>
</body>
</html>
